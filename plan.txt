# NetBird Minimal C Client - å¯¦ä½œè¨ˆåŠƒ

## å°ˆæ¡ˆæ¦‚è¿°

æœ¬å°ˆæ¡ˆç›®æ¨™æ˜¯å°‡ NetBird client å¾ Go èªè¨€ç§»æ¤åˆ° C èªè¨€ï¼Œå°ˆæ³¨æ–¼ Linux å¹³å°çš„æœ€å°åŒ–å¯¦ä½œã€‚

### æ ¸å¿ƒç›®æ¨™
- **å¹³å°**: åƒ…æ”¯æ´ Linuxï¼ˆåŒ…å« OpenWrtï¼‰
- **WireGuard**: ä½¿ç”¨ Kernel WireGuard + ç¾æœ‰å·¥å…·/library
- **ç¶²è·¯**: å–®ä¸€ Management server + å–®ä¸€ Signal server
- **åŠŸèƒ½**: setup-key â†’ join network â†’ å»ºç«‹ tunnel â†’ äº’ ping
- **é€£ç·š**: æ”¯æ´ P2P / Relay (ICE ä½¿ç”¨ç¾æˆ libnice)

### ä¸æ”¯æ´åŠŸèƒ½
- å…¶ä»–å¹³å° (Windows, macOS, Android, iOS)
- å¤šç¶²è·¯æ”¯æ´
- SSH, DNS, Firewall ç­‰é€²éšåŠŸèƒ½
- UI ä»‹é¢

---

## å°ˆæ¡ˆçµæ§‹

```
netbird-minimal/
â”œâ”€â”€ README.md                           # å°ˆæ¡ˆç¸½è¦½
â”œâ”€â”€ plan.txt                            # æœ¬æª”æ¡ˆ
â”œâ”€â”€ .gitignore
â”‚
â”œâ”€â”€ doc/                                # æ–‡ä»¶ç›®éŒ„
â”‚   â”œâ”€â”€ GO_CODE_OVERVIEW.md            # Go ç¨‹å¼ç¢¼èªªæ˜
â”‚   â”œâ”€â”€ GO_TO_C_MAPPING.md             # Go åˆ° C å°æ‡‰è©³è§£
â”‚   â”œâ”€â”€ GO_PORTING_SUMMARY.md          # Go ç§»æ¤éšæ®µç¸½çµ
â”‚   â””â”€â”€ IMPLEMENTATION_CHECKLIST.md    # C å¯¦ä½œæª¢æŸ¥æ¸…å–®
â”‚
â”œâ”€â”€ go/                                 # Go åƒè€ƒç¨‹å¼ç¢¼
â”‚   â”œâ”€â”€ go.mod
â”‚   â”œâ”€â”€ cmd/                           # CLI å‘½ä»¤å¯¦ä½œ
â”‚   â”œâ”€â”€ internal/                      # æ ¸å¿ƒå¼•æ“
â”‚   â”œâ”€â”€ iface/                         # WireGuard ä»‹é¢
â”‚   â”œâ”€â”€ management/client/             # Management å®¢æˆ¶ç«¯
â”‚   â”œâ”€â”€ signal/client/                 # Signal å®¢æˆ¶ç«¯
â”‚   â””â”€â”€ proto/                         # Protocol Buffers å®šç¾©
â”‚       â”œâ”€â”€ management.proto
â”‚       â””â”€â”€ signalexchange.proto
â”‚
â””â”€â”€ c/                                  # C èªè¨€å¯¦ä½œ (å¾…é–‹ç™¼)
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ include/                       # æ¨™é ­æª”
    â”‚   â”œâ”€â”€ engine.h
    â”‚   â”œâ”€â”€ wg_iface.h
    â”‚   â”œâ”€â”€ mgmt_client.h
    â”‚   â”œâ”€â”€ signal_client.h
    â”‚   â”œâ”€â”€ route.h
    â”‚   â””â”€â”€ config.h
    â”œâ”€â”€ src/                           # åŸå§‹æª”
    â”‚   â”œâ”€â”€ main.c
    â”‚   â”œâ”€â”€ engine.c
    â”‚   â”œâ”€â”€ wg_iface.c
    â”‚   â”œâ”€â”€ mgmt_client.c
    â”‚   â”œâ”€â”€ signal_client.c
    â”‚   â”œâ”€â”€ route.c
    â”‚   â””â”€â”€ config.c
    â”œâ”€â”€ proto/                         # Proto ç”Ÿæˆçš„ C ç¨‹å¼ç¢¼
    â””â”€â”€ test/                          # æ¸¬è©¦ç¨‹å¼
```

---

## ç•¶å‰é€²åº¦

### âœ… Phase 0: Go ç¨‹å¼ç¢¼æº–å‚™ (å·²å®Œæˆ)

å·²å¾ NetBird å®˜æ–¹å°ˆæ¡ˆè¤‡è£½ä¸¦æ•´ç†ï¼š
- 71 å€‹ Go åŸå§‹æª”ï¼ˆ696KBï¼‰
- æ ¸å¿ƒæ¨¡çµ„: Engine, WireGuard Interface, Management/Signal clients
- Proto å®šç¾©æª”æ¡ˆ
- è©³ç´°æ–‡ä»¶å’Œ C å°æ‡‰èªªæ˜

åƒè¦‹: `doc/GO_PORTING_SUMMARY.md`

### â­ï¸ Phase 1: WireGuard + Route æ¨¡çµ„ (é€²è¡Œä¸­)

**ç›®æ¨™**: å¯¦ä½œ WireGuard ä»‹é¢ç®¡ç†å’Œè·¯ç”±è¨­å®š

**å¯¦ä½œé‡é»**:

#### 1. WireGuard Interface (c/wg_iface.c)

å°ç…§ Go æª”æ¡ˆ: `go/iface/iface_new_linux.go`, `go/iface/device/wg_link_linux.go`

```c
// c/include/wg_iface.h
typedef struct wg_iface wg_iface_t;

int wg_iface_create(const nb_config_t *cfg, wg_iface_t **out);
int wg_iface_up(wg_iface_t *iface);
int wg_iface_update_peer(
    wg_iface_t *iface,
    const char *peer_pubkey,
    const char *allowed_ips,     // "100.64.0.6/32,10.0.0.0/24"
    int persistent_keepalive,    // seconds
    const char *endpoint,         // "203.0.113.5:51820" or NULL
    const char *preshared_key     // or NULL
);
int wg_iface_remove_peer(wg_iface_t *iface, const char *peer_pubkey);
int wg_iface_destroy(wg_iface_t *iface);
```

**å¯¦ä½œæ–¹å¼** (é¸æ“‡å…¶ä¸€):

é¸é … A - å¿«é€ŸåŸå‹ (å»ºè­°å…ˆåš):
```c
// ä½¿ç”¨ shell å‘½ä»¤
system("ip link add dev wt0 type wireguard");
system("ip address add 100.64.0.5/16 dev wt0");
system("wg set wt0 private-key /tmp/key listen-port 51820");
system("ip link set wt0 up");
```

é¸é … B - æ­£å¼ç‰ˆæœ¬:
```c
// ä½¿ç”¨ libmnl (netlink library)
// ç›´æ¥æ“ä½œ kernelï¼Œç„¡éœ€ fork å¤–éƒ¨å‘½ä»¤
```

**æ¸¬è©¦ç›®æ¨™**:
- èƒ½å»ºç«‹ WireGuard ä»‹é¢
- èƒ½æ‰‹å‹•é€£æ¥åˆ°ç¾æœ‰ WireGuard server
- èƒ½äº’ ping

---

#### 2. Route Manager (c/route.c)

å°ç…§ Go æª”æ¡ˆ: `go/internal/routemanager/systemops/systemops_linux.go`

```c
// c/include/route.h
typedef struct route_manager route_manager_t;

typedef struct {
    char *network;      // "10.0.0.0/8" (CIDR)
    char *device;       // "wt0"
    int metric;         // å„ªå…ˆåº¦
    int masquerade;     // NAT
} route_config_t;

route_manager_t* route_manager_new(const char *wg_device);
int route_add(route_manager_t *mgr, const route_config_t *route);
int route_remove(route_manager_t *mgr, const char *network);
void route_manager_free(route_manager_t *mgr);
```

**å¯¦ä½œæ–¹å¼**:

é¸é … A - å¿«é€ŸåŸå‹:
```c
system("ip route add 10.0.0.0/8 dev wt0 metric 100");
```

é¸é … B - æ­£å¼ç‰ˆæœ¬:
```c
// ä½¿ç”¨ libmnl netlink API
```

---

### Phase 2: Management Client

**ç›®æ¨™**: å¯¦ä½œèˆ‡ Management Server çš„ gRPC é€šè¨Š

å°ç…§ Go æª”æ¡ˆ: `go/management/client/grpc.go`

#### 1. ç·¨è­¯ Proto

```bash
cd c/
protoc --c_out=proto/ ../go/proto/management.proto
# ç”Ÿæˆ: management.pb-c.h, management.pb-c.c
```

#### 2. Management Client (c/mgmt_client.c)

```c
// c/include/mgmt_client.h
typedef struct mgmt_client mgmt_client_t;

typedef struct {
    char *peer_id;
    char *public_key;
    char **allowed_ips;
    int allowed_ips_count;
    char *endpoint;
    int persistent_keepalive;
} peer_info_t;

typedef struct {
    char *network;      // "10.0.0.0/8"
    char *peer;
    int metric;
    int masquerade;
} route_t;

mgmt_client_t* mgmt_client_new(const char *url);

int mgmt_register(
    mgmt_client_t *c,
    const char *setup_key,
    const char *wg_pubkey,
    // Output parameters:
    char **peer_id_out,
    char **wg_addr_out,
    peer_info_t **peers_out,
    int *peers_count_out,
    route_t **routes_out,
    int *routes_count_out
);

int mgmt_sync(
    mgmt_client_t *c,
    const char *peer_id,
    peer_info_t **peers_out,
    int *peers_count_out,
    route_t **routes_out,
    int *routes_count_out
);

void mgmt_client_free(mgmt_client_t *c);
```

**ä¾è³´ library**:
- protobuf-c: https://github.com/protobuf-c/protobuf-c
- grpc-c: https://github.com/lixiangyun/grpc-c (æˆ–å…¶ä»– C binding)

#### 3. Config ç®¡ç† (c/config.c)

å°ç…§ Go æª”æ¡ˆ: `go/internal/config.go` (éœ€å¾å®˜æ–¹å°ˆæ¡ˆè£œå……)

```c
// c/include/config.h
typedef struct {
    char *private_key;          // WG private key
    char *management_url;
    char *signal_url;
    char *admin_url;

    char *wg_iface_name;       // "wt0"
    char *wg_address;          // "100.64.0.5/16"
    int wg_listen_port;        // 51820
    char *preshared_key;

    char **nat_external_ips;
    int nat_external_ips_count;
} nb_config_t;

int config_load(const char *path, nb_config_t **cfg_out);
int config_save(const char *path, const nb_config_t *cfg);
void config_free(nb_config_t *cfg);
```

**æ ¼å¼**: JSON (èˆ‡ Go client ç›¸å®¹)
**Library**: cJSON (https://github.com/DaveGamble/cJSON)

**æ¸¬è©¦ç›®æ¨™**:
- èƒ½é€£æ¥åˆ° Management Server
- èƒ½ç”¨ setup-key è¨»å†Š
- åœ¨ Management UI çœ‹åˆ°æ–°çš„ peer
- èƒ½æ”¶åˆ° peer åˆ—è¡¨å’Œè·¯ç”±

---

### Phase 3: Engine æ•´åˆ

**ç›®æ¨™**: ä¸²æ¥ WireGuard + Managementï¼Œå¯¦ç¾å®Œæ•´å•Ÿå‹•æµç¨‹

å°ç…§ Go æª”æ¡ˆ: `go/internal/engine.go`

```c
// c/include/engine.h
typedef struct nb_engine nb_engine_t;

nb_engine_t* nb_engine_new(const nb_config_t *cfg);
int nb_engine_start(nb_engine_t *eng);
void nb_engine_stop(nb_engine_t *eng);
void nb_engine_free(nb_engine_t *eng);
```

**å•Ÿå‹•æµç¨‹**:

```
nb_engine_start()
  â”œâ”€> 1. è¼‰å…¥/å»ºç«‹ config
  â”œâ”€> 2. åˆå§‹åŒ– mgmt_client
  â”œâ”€> 3. mgmt_register(setup_key)
  â”‚    â””â”€> æ”¶åˆ°: peer_id, wg_addr, peers, routes
  â”œâ”€> 4. wg_iface_create()
  â”‚    â””â”€> å»ºç«‹ WireGuard ä»‹é¢
  â”œâ”€> 5. wg_iface_up()
  â”œâ”€> 6. ç‚ºæ¯å€‹ peer:
  â”‚    â””â”€> wg_iface_update_peer()
  â”œâ”€> 7. ç‚ºæ¯å€‹ route:
  â”‚    â””â”€> route_add()
  â””â”€> 8. å•Ÿå‹•åŒæ­¥ loop (å®šæœŸ mgmt_sync)
```

**åœæ­¢æµç¨‹**:

```
nb_engine_stop()
  â”œâ”€> 1. åœæ­¢åŒæ­¥ loop
  â”œâ”€> 2. route_remove() (æ‰€æœ‰è·¯ç”±)
  â”œâ”€> 3. wg_iface_remove_peer() (æ‰€æœ‰ peers)
  â”œâ”€> 4. wg_iface_destroy()
  â””â”€> 5. mgmt_client_free()
```

**æ¸¬è©¦ç›®æ¨™**:
- å…©å°æ©Ÿå™¨èƒ½é€é relay server äº’ ping
- èƒ½æ­£ç¢ºå•Ÿå‹•å’Œåœæ­¢
- Config æ­£ç¢ºå„²å­˜å’Œè¼‰å…¥

---

### Phase 4: Signal Client + ICE

**ç›®æ¨™**: å¯¦ä½œ P2P é€£ç·š

å°ç…§ Go æª”æ¡ˆ: `go/signal/client/grpc.go`

#### 1. ç·¨è­¯ Proto

```bash
protoc --c_out=proto/ ../go/proto/signalexchange.proto
```

#### 2. Signal Client (c/signal_client.c)

```c
// c/include/signal_client.h
typedef struct signal_client signal_client_t;

typedef struct {
    char *from;         // Sender peer ID
    char *to;           // Recipient peer ID
    char *type;         // "offer" / "answer" / "candidate"
    char *sdp;          // For offer/answer
    char *candidate;    // For ICE candidate
} signal_message_t;

signal_client_t* signal_client_new(const char *url);
int signal_subscribe(signal_client_t *c, const char *peer_id);
int signal_send(signal_client_t *c, const char *to_peer,
                const char *msg_type, const char *content);
int signal_receive(signal_client_t *c, signal_message_t *msg_out);
void signal_client_free(signal_client_t *c);
```

#### 3. ICE æ•´åˆ (libnice)

å°ç…§ Go: NetBird ä½¿ç”¨ Pion ICEï¼ŒC ç‰ˆä½¿ç”¨ libnice

```c
// å½ä»£ç¢¼æµç¨‹
ice_agent = nice_agent_new();
nice_agent_add_stream(agent, 1);

// æ”¶åˆ° Signal offer
on_signal_offer(offer_sdp) {
    nice_agent_parse_remote_sdp(agent, offer_sdp);
    nice_agent_gather_candidates(agent);
    local_sdp = nice_agent_generate_local_sdp(agent);
    signal_send(peer_id, "answer", local_sdp);
}

// ICE é€£ç·šå»ºç«‹
on_ice_connected(ip, port) {
    wg_iface_update_peer(peer_pubkey, ..., endpoint=ip:port);
}
```

**Library**: libnice (https://nice.freedesktop.org/)

**æ¸¬è©¦ç›®æ¨™**:
- å…©å°æ©Ÿå™¨åœ¨ LAN å…§ P2P ç›´é€£
- è·¨ NAT ç’°å¢ƒ P2P é€£ç·š
- å›é€€åˆ° relay æ¨¡å¼

---

### Phase 5: CLI

**ç›®æ¨™**: å¯¦ä½œå®Œæ•´å‘½ä»¤åˆ—ä»‹é¢

å°ç…§ Go æª”æ¡ˆ: `go/cmd/up.go`, `go/cmd/down.go`, `go/cmd/status.go`

```c
// c/src/main.c
int main(int argc, char *argv[]) {
    if (strcmp(argv[1], "up") == 0) {
        return cmd_up(argc, argv);
    } else if (strcmp(argv[1], "down") == 0) {
        return cmd_down();
    } else if (strcmp(argv[1], "status") == 0) {
        return cmd_status();
    }
    // ...
}

int cmd_up(int argc, char *argv[]) {
    // è§£æ --setup-key, --management-url ç­‰
    nb_config_t *cfg = parse_args_and_load_config(argc, argv);

    nb_engine_t *engine = nb_engine_new(cfg);
    nb_engine_start(engine);

    // Daemon æ¨¡å¼
    if (daemonize) {
        fork_to_background();
        write_pidfile();
    }

    // ç­‰å¾… signal
    wait_for_termination_signal();

    nb_engine_stop(engine);
    nb_engine_free(engine);
}

int cmd_down(void) {
    // è®€å– PID
    // ç™¼é€ SIGTERM çµ¦ daemon
    // ç­‰å¾…åœæ­¢å®Œæˆ
}

int cmd_status(void) {
    // æŸ¥è©¢åŸ·è¡Œä¸­çš„ daemon (Unix socket or shared memory)
    // é¡¯ç¤ºç‹€æ…‹
    printf("Daemon status: Connected\n");
    printf("Management: Connected\n");
    printf("Signal: Connected\n");
    printf("NetBird IP: 100.64.0.5/16\n");
    printf("Peers: 3/5 Connected\n");
}
```

**åŠŸèƒ½éœ€æ±‚**:
- å‘½ä»¤åˆ—åƒæ•¸è§£æ
- Daemon æ¨¡å¼ (fork, pidfile)
- Signal handler (SIGTERM, SIGINT)
- IPC æ©Ÿåˆ¶ (daemon å’Œ CLI é€šè¨Š)

**æ¸¬è©¦ç›®æ¨™**:
```bash
$ sudo nbc up --setup-key A1B2C3... --management-url https://api.example.com
NetBird started successfully

$ nbc status
Daemon status: Connected
Management: Connected
Signal: Connected
NetBird IP: 100.64.0.5/16
Peers: 3/5 Connected

$ nbc down
NetBird stopped
```

---

## å¯¦ä½œå»ºè­°

### é–‹ç™¼é †åº

1. **Phase 1**: WireGuard + Route (å…ˆç”¨ shell å‘½ä»¤å¿«é€Ÿå¯¦ä½œ)
   - é ä¼°: 3-5 å¤©
   - é©—æ”¶: èƒ½å»ºç«‹ WG éš§é“

2. **Phase 2**: Management Client
   - é ä¼°: 5-7 å¤©
   - é©—æ”¶: èƒ½è¨»å†Š peer

3. **Phase 3**: Engine æ•´åˆ
   - é ä¼°: 3-5 å¤©
   - é©—æ”¶: å…©å°æ©Ÿå™¨èƒ½äº’ ping (relay æ¨¡å¼)

4. **Phase 4**: Signal + ICE
   - é ä¼°: 5-7 å¤©
   - é©—æ”¶: P2P ç›´é€£

5. **Phase 5**: CLI
   - é ä¼°: 2-3 å¤©
   - é©—æ”¶: å®Œæ•´ CLI é«”é©—

**ç¸½è¨ˆ**: 3-4 é€±å¯å®Œæˆ MVP (Minimal Viable Product)

### å¿«é€ŸåŸå‹ vs æ­£å¼ç‰ˆæœ¬

**å¿«é€ŸåŸå‹** (å»ºè­°å…ˆåš):
- âœ… ä½¿ç”¨ shell å‘½ä»¤ (wg, ip route)
- âœ… å–®åŸ·è¡Œç·’
- âœ… ç°¡å–®éŒ¯èª¤è™•ç†
- âœ… Relay æ¨¡å¼ç‚ºä¸»
- ğŸ¯ ç›®æ¨™: 2 é€±å…§è·‘èµ·ä¾†

**æ­£å¼ç‰ˆæœ¬** (ä¹‹å¾Œå„ªåŒ–):
- â­ ä½¿ç”¨ libmnl (netlink)
- â­ å¤šåŸ·è¡Œç·’ (pthread)
- â­ å®Œå–„éŒ¯èª¤è™•ç†å’Œé‡é€£
- â­ å®Œæ•´ P2P (libnice)
- ğŸ¯ ç›®æ¨™: 1 å€‹æœˆå…§å®Œæˆ

---

## ä¾è³´é …ç›®

### ç³»çµ±éœ€æ±‚
- Linux Kernel 5.6+ (å…§å»º WireGuard)
- æˆ– WireGuard kernel module

### å¿…è¦å·¥å…·
```bash
apt-get install wireguard-tools iproute2
```

### å¿…è¦ Library
```bash
# Protocol Buffers
apt-get install protobuf-c-compiler libprotobuf-c-dev

# gRPC (å¯èƒ½éœ€æ‰‹å‹•ç·¨è­¯)
# åƒè€ƒ: https://github.com/lixiangyun/grpc-c

# ICE
apt-get install libnice-dev

# JSON
apt-get install libcjson-dev

# Netlink (optional, æ­£å¼ç‰ˆæ‰éœ€è¦)
apt-get install libmnl-dev
```

### æ¬Šé™
```bash
# æ–¹å¼ 1: root
sudo ./nbc up

# æ–¹å¼ 2: capability
sudo setcap cap_net_admin+ep ./nbc
./nbc up
```

---

## æ¸¬è©¦ç’°å¢ƒ

### æœ€å°æ¸¬è©¦
- 2 å° Linux æ©Ÿå™¨ï¼ˆVM æˆ–å¯¦é«”æ©Ÿï¼‰
- å¯è¨ªå•çš„ NetBird Management Server
- å¯è¨ªå•çš„ NetBird Signal Server

### é€²éšæ¸¬è©¦
- NAT ç’°å¢ƒæ¸¬è©¦
- OpenWrt è·¯ç”±å™¨æ¸¬è©¦
- è·¨ç¶²æ®µæ¸¬è©¦

---

## åƒè€ƒè³‡æº

### å°ˆæ¡ˆæ–‡ä»¶
- `README.md` - å°ˆæ¡ˆç¸½è¦½
- `doc/GO_CODE_OVERVIEW.md` - Go ç¨‹å¼ç¢¼èªªæ˜
- `doc/GO_TO_C_MAPPING.md` - Go åˆ° C è©³ç´°å°æ‡‰
- `doc/IMPLEMENTATION_CHECKLIST.md` - å¯¦ä½œæª¢æŸ¥æ¸…å–®

### å¤–éƒ¨è³‡æº
- NetBird å®˜æ–¹: https://github.com/netbirdio/netbird
- WireGuard: https://www.wireguard.com/
- libmnl (netlink): https://www.netfilter.org/projects/libmnl/
- protobuf-c: https://github.com/protobuf-c/protobuf-c
- grpc-c: https://github.com/lixiangyun/grpc-c
- libnice (ICE): https://nice.freedesktop.org/
- cJSON: https://github.com/DaveGamble/cJSON

---

## License

æœ¬å°ˆæ¡ˆåŸºæ–¼ NetBird å®˜æ–¹å°ˆæ¡ˆï¼Œéµå¾ª BSD-3-Clause Licenseã€‚

---

## ç‰ˆæœ¬æ­·å²

- **v0.1** (2025-11-30): Go ç¨‹å¼ç¢¼æº–å‚™å®Œæˆï¼Œé–‹å§‹ C å¯¦ä½œ
- **v0.2** (TBD): Phase 1-3 å®Œæˆ (Relay æ¨¡å¼å¯ç”¨)
- **v0.3** (TBD): Phase 4 å®Œæˆ (P2P å¯ç”¨)
- **v1.0** (TBD): Phase 5 å®Œæˆ (å®Œæ•´ CLI)

---

**æœ€å¾Œæ›´æ–°**: 2025-11-30
**ç•¶å‰ç‹€æ…‹**: Go ç¨‹å¼ç¢¼æº–å‚™å®Œæˆï¼Œé€²å…¥ C å¯¦ä½œéšæ®µ
**ä¸‹ä¸€æ­¥**: Phase 1 - WireGuard Interface + Route Manager
